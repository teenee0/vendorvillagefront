# Руководство по автообновлению токенов

## Обзор

Система автообновления токенов обеспечивает бесперебойную работу пользователей без необходимости повторной авторизации. Система автоматически обновляет JWT токены до их истечения и обрабатывает ошибки аутентификации.

## Компоненты системы

### 1. useAuth Hook (`src/hooks/useAuth.js`)

Центральный хук для управления состоянием аутентификации:

```javascript
const { 
  isAuthenticated,  // Статус аутентификации
  isLoading,        // Состояние загрузки
  user,            // Данные пользователя
  checkAuth,       // Проверка аутентификации
  refreshToken,    // Обновление токена
  logout          // Выход из системы
} = useAuth();
```

### 2. HTTP Interceptors (`src/api/axiosDefault.js`)

Автоматические интерцепторы для обработки токенов:

- **Request Interceptor**: Добавляет CSRF токены к запросам
- **Response Interceptor**: Автоматически обновляет токены при получении 401 ошибки

### 3. TokenRefreshManager (`src/components/TokenRefreshManager/TokenRefreshManager.jsx`)

Компонент для периодического обновления токенов:

- Обновляет токены каждые 15 минут
- Проверяет токены при фокусе окна
- Работает только для аутентифицированных пользователей

### 4. TokenTest (`src/components/TokenTest/TokenTest.jsx`)

Тестовый компонент для проверки работы системы токенов. **Отображается только в режиме разработки** (`NODE_ENV === 'development'`).

### 5. DevUtils (`src/utils/devUtils.js`)

Утилиты для работы с режимом разработки:

```javascript
import { isDevelopment, devLog, devWarn, devError } from '../utils/devUtils';

// Проверка режима
if (isDevelopment()) {
  // Код только для разработки
}

// Логирование только в разработке
devLog('Отладочная информация');
devWarn('Предупреждение');
devError('Ошибка');
```

## Как это работает

### Автоматическое обновление

1. **Периодическое обновление**: Каждые 15 минут система автоматически обновляет access токен
2. **Обновление при фокусе**: При возвращении на вкладку проверяется валидность токена
3. **Обновление при ошибке**: При получении 401 ошибки система автоматически пытается обновить токен

### Обработка ошибок

1. **Успешное обновление**: Запрос повторяется с новым токеном
2. **Неудачное обновление**: Пользователь перенаправляется на страницу логина
3. **Очередь запросов**: Во время обновления токена все запросы ставятся в очередь

## Настройки

### Время жизни токенов (Backend)

```python
SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(minutes=20),  # Access токен
    "REFRESH_TOKEN_LIFETIME": timedelta(days=90),   # Refresh токен
    "ROTATE_REFRESH_TOKENS": True,                  # Ротация refresh токенов
    "BLACKLIST_AFTER_ROTATION": True,               # Блэклист старых токенов
}
```

### Интервал обновления (Frontend)

```javascript
// В TokenRefreshManager.jsx
setInterval(async () => {
  await refreshToken();
}, 15 * 60 * 1000); // 15 минут
```

## Использование

### В компонентах

```javascript
import { useAuth } from '../hooks/useAuth';

const MyComponent = () => {
  const { isAuthenticated, user, logout } = useAuth();
  
  if (!isAuthenticated) {
    return <div>Пожалуйста, войдите в систему</div>;
  }
  
  return <div>Добро пожаловать, {user.email}!</div>;
};
```

### API вызовы

```javascript
import axios from '../api/axiosDefault';

// Токены обновляются автоматически
const response = await axios.get('/api/some-endpoint/');
```

## Тестирование

1. Войдите в систему
2. Перейдите на страницу аккаунта
3. Используйте тестовый компонент для проверки:
   - API вызовов
   - Обновления токенов
   - Статуса аутентификации

## Логирование

Система выводит подробные логи в консоль **только в режиме разработки**:

- `[DEV] Автоматическое обновление токена...` - Начало обновления
- `[DEV] Токен успешно обновлен` - Успешное обновление
- `[DEV WARNING] Ошибка обновления токена:` - Ошибки обновления

Используются утилиты `devLog()` и `devWarn()` из `devUtils.js` для логирования только в режиме разработки.

## Устранение неполадок

### Токен не обновляется

1. Проверьте настройки CORS на бэкенде
2. Убедитесь, что refresh токен не истек
3. Проверьте логи в консоли браузера

### Пользователь не перенаправляется на логин

1. Проверьте настройки роутинга
2. Убедитесь, что PrivateRoute использует useAuth
3. Проверьте обработку ошибок в интерцепторах

### Множественные запросы обновления

1. Система автоматически предотвращает множественные запросы
2. Запросы ставятся в очередь во время обновления
3. Проверьте флаг `isRefreshing` в коде

## Безопасность

- Токены хранятся в httpOnly cookies
- CSRF защита включена
- Автоматическая очистка при выходе
- Ротация refresh токенов
